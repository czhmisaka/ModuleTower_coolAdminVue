import{i as N,e as Z,r as ee,f as S}from"./index-1e0489aa.js";import"./store-acb3382e.js";import{u as J}from"./index-eba40255.js";import{u as H}from"./hook-6b6f6a66.js";import{v as te,w as ne}from"./@vue.runtime-dom-592c53ed.js";import{T as oe,U as re,E as le}from"./@element-plus.icons-vue-c499527b.js";import{b as U,a as C}from"./element-plus-7426fe99.js";import{w as se}from"./lodash-es-74a5df03.js";import{d as D,f as ae,X as i,$ as Q,o as I,c as A,a as x,e as n,K as p,N as j,L as O,O as G,J as L,n as ie,as as pe,ar as ce}from"./@vue.runtime-core-0029b467.js";import{r as R,u as v}from"./@vue.reactivity-b2e38c7a.js";import{o as de,O as ue}from"./@vue.shared-ccdbf9b9.js";import{_ as me}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vueuse.core-bf8dfe85.js";import"./@vueuse.shared-501e3e4b.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-6d4e9d4f.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-6b15fa8a.js";import"./mockjs-597bdf6e.js";import"./vue-aac48648.js";import"./dayjs-20b85df8.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";const _e=y=>(pe("data-v-2f435e42"),y=y(),ce(),y),fe={class:"dept-tree"},be={class:"dept-tree__header"},he=_e(()=>x("div",null,"组织架构",-1)),ve={class:"dept-tree__op"},ye={class:"no"},ge=["onContextmenu"],we={class:"dept-tree__node"},ke=["onClick"],xe=D({name:"dept-list"}),Ce=D({...xe,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["refresh","user-add"],setup(y,{emit:g}){const B=y,$=g,{service:_,browser:w}=J(),{ViewGroup:m}=H(),f=N.useForm(),d=R([]),k=R(!1),b=R(!1);function r({data:t}){return t.parentId}function l(t,e){return e.data.parentId}async function c(){k.value=!0,b.value=!1,await _.base.sys.department.list().then(t=>{var e;d.value=Z(t),(e=m.value)!=null&&e.selected||h()}),k.value=!1}function h(t){var e;if(t||(t=d.value[0]),t){const s=t.children?ee(t.children).map(o=>o.id):[];s.unshift(t.id),(e=m.value)==null||e.select(t),ie(()=>{$("refresh",{page:1,departmentIds:s})})}}function F(t){var s;const e=t.id?"update":"add";(s=f.value)==null||s.open({title:"编辑部门",width:"550px",props:{labelWidth:"100px"},items:[{label:"部门名称",prop:"name",component:{name:"el-input"},required:!0},{label:"上级部门",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:{...t},on:{submit(o,{done:a,close:u}){_.base.sys.department[e]({id:t.id,parentId:t.parentId,name:o.name,orderNum:o.orderNum}).then(()=>{C.success(`新增部门 “${o.name}” 成功`),u(),c()}).catch(M=>{C.error(M.message),a()})}}},[N.setFocus()])}function q(t){async function e(s){await _.base.sys.department.delete({ids:[t.id],deleteUser:s}).then(()=>{var o,a;((a=(o=m.value)==null?void 0:o.selected)==null?void 0:a.id)==t.id&&h(),s?C.success("删除成功"):U.confirm(`“${t.name}” 部门的用户已成功转移到 “${t.parentName}” 部门。`,"删除成功")}),c()}U.confirm(`此操作将会删除 “${t.name}” 部门的所有用户，是否确认？`,"提示",{type:"warning",confirmButtonText:"直接删除",cancelButtonText:"保留用户",distinguishCancelAndClose:!0}).then(()=>{e(!0)}).catch(s=>{s=="cancel"&&e(!1)})}function V(t){t?U.confirm("部门架构已发生改变，是否保存？","提示",{type:"warning"}).then(async()=>{const e=[];function s(o,a){o.forEach(u=>{u.parentId=a,e.push(u),u.children&&se(u.children)&&s(u.children,u.id)})}s(d.value,null),await _.base.sys.department.order(e.map((o,a)=>({id:o.id,parentId:o.parentId,orderNum:a}))).then(()=>{C.success("更新排序成功")}).catch(o=>{C.error(o.message)}),c(),b.value=!1}).catch(()=>null):c()}function E(t,e,s){e||(e=d.value[0]||{});const o=_.base.sys.department.permission;N.ContextMenu.open(t,{list:[{label:"新增",hidden:s&&s.level>=B.level||!S(o.add),callback(a){F({name:"",parentName:e.name,parentId:e.id}),a()}},{label:"编辑",hidden:!S(o.update),callback(a){F(e),a()}},{label:"删除",hidden:!e.parentId||!S(o.delete),callback(a){q(e),a()}},{label:"新增成员",hidden:!S(o.add),callback(a){$("user-add",e),a()}}]})}return ae(function(){c()}),(t,e)=>{const s=i("el-icon"),o=i("el-tooltip"),a=i("el-button"),u=i("el-tree"),M=i("el-scrollbar"),T=i("cl-form"),z=Q("loading");return I(),A("div",fe,[x("div",be,[he,x("ul",ve,[x("li",{onClick:e[0]||(e[0]=W=>c())},[n(o,{content:"刷新"},{default:p(()=>[n(s,null,{default:p(()=>[n(v(oe))]),_:1})]),_:1})]),y.drag&&!v(w).isMini?(I(),A("li",{key:0,onClick:e[1]||(e[1]=W=>b.value=!0)},[n(o,{content:"拖动排序"},{default:p(()=>[n(s,null,{default:p(()=>[n(v(re))]),_:1})]),_:1})])):j("",!0),O(x("li",ye,[n(a,{onClick:e[2]||(e[2]=W=>V(!0)),size:"small"},{default:p(()=>[G("保存")]),_:1}),n(a,{onClick:e[3]||(e[3]=W=>V(!1)),size:"small"},{default:p(()=>[G("取消")]),_:1})],512),[[te,b.value]])])]),x("div",{class:"dept-tree__container",onContextmenu:ne(E,["stop","prevent"])},[n(M,null,{default:p(()=>[O((I(),L(u,{"node-key":"id","default-expand-all":"",data:d.value,props:{label:"name"},"highlight-current":"",draggable:b.value,"allow-drag":r,"allow-drop":l,"expand-on-click-node":!1,onNodeContextmenu:E,onNodeClick:h},{default:p(({node:W,data:K})=>{var P,X;return[x("div",we,[x("span",{class:de(["dept-tree__node-label",{"is-active":K.id==((X=(P=v(m))==null?void 0:P.selected)==null?void 0:X.id)}])},ue(W.label),3),v(w).isMini?(I(),A("span",{key:0,class:"dept-tree__node-icon",onClick:Y=>E(Y,K,W)},[n(s,null,{default:p(()=>[n(v(le))]),_:1})],8,ke)):j("",!0)])]}),_:1},8,["data","draggable"])),[[z,k.value]])]),_:1})],40,ge),n(T,{ref_key:"Form",ref:f},null,512)])}}});const Ie=me(Ce,[["__scopeId","data-v-2f435e42"]]),Ne={class:"dept-move"},$e=D({name:"user-move"}),Me=D({...$e,setup(y,{expose:g}){const{service:B}=J(),$=N.useForm(),_=N.useCrud();async function w(m){var f;(f=$.value)==null||f.open({title:"部门转移",width:"500px",props:{labelWidth:"80px"},items:[{label:"选择部门",prop:"departmentId",component:{name:"cl-dept-select"}}],on:{submit(d,{done:k,close:b}){if(!d.departmentId)return C.warning("请选择部门"),k();U.confirm("转移到新部门，是否继续？","提示",{type:"warning"}).then(()=>{B.base.sys.user.move({...d,userIds:m}).then(()=>{var r;C.success("转移成功"),(r=_.value)==null||r.refresh(),b()}).catch(r=>{C.error(r.message),k()})}).catch(()=>null)}}})}return g({open:w}),(m,f)=>{const d=i("cl-form");return I(),A("div",Ne,[n(d,{ref_key:"Form",ref:$},null,512)])}}}),Te=D({name:"sys-user"}),_t=D({...Te,setup(y){const{service:g,refs:B,setRefs:$}=J(),{ViewGroup:_}=H({title:"用户列表"}),w=N.useCrud({service:g.base.sys.user}),m=N.useTable({columns:[{type:"selection",width:60},{prop:"headImg",label:"头像",component:{name:"cl-avatar"}},{prop:"username",label:"用户名",minWidth:150},{prop:"name",label:"姓名",minWidth:150},{prop:"nickName",label:"昵称",minWidth:150},{prop:"departmentName",label:"部门名称",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:150,dict:[],formatter(r){var l;return(l=r.roleName)==null?void 0:l.split(",")}},{prop:"status",label:"状态",minWidth:120,component:{name:"cl-switch"}},{prop:"phone",label:"手机号码",minWidth:150},{prop:"remark",label:"备注",minWidth:150},{prop:"createTime",label:"创建时间",sortable:"desc",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),f=N.useUpsert({dialog:{width:"800px"},items:[{prop:"headImg",label:"头像",component:{name:"cl-upload",props:{text:"选择头像"}}},{prop:"name",label:"姓名",span:12,required:!0,component:{name:"el-input"}},{prop:"nickName",label:"昵称",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用户名",required:!0,span:12,component:{name:"el-input"}},()=>{var r;return{prop:"password",label:"密码",span:12,required:((r=f.value)==null?void 0:r.mode)=="add",component:{name:"el-input",props:{type:"password"}},rules:[{min:6,max:16,message:"密码长度在 6 到 16 个字符"}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":3}}},{prop:"phone",label:"手机号码",span:12,component:{name:"el-input"}},{prop:"email",label:"邮箱",span:12,component:{name:"el-input"}},{prop:"remark",label:"备注",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"status",label:"状态",value:1,component:{name:"el-radio-group",options:[{label:"开启",value:1},{label:"关闭",value:0}]}}],onSubmit(r,{next:l}){var c,h;l({departmentId:(h=(c=_.value)==null?void 0:c.selected)==null?void 0:h.id,...r})},async onOpen(){g.base.sys.role.list().then(r=>{var l;(l=f.value)==null||l.setOptions("roleIdList",r.map(c=>({label:c.name||"",value:c.id})))})}});function d(r){var l;(l=w.value)==null||l.refresh(r)}function k({id:r}){var l;(l=w.value)==null||l.rowAppend({departmentId:r})}async function b(r){var c;let l=[];r?l=[r.id]:l=((c=m.value)==null?void 0:c.selection.map(h=>h.id))||[],B.userMove.open(l)}return(r,l)=>{const c=i("cl-refresh-btn"),h=i("cl-add-btn"),F=i("cl-multi-delete-btn"),q=i("el-button"),V=i("cl-flex1"),E=i("cl-search-key"),t=i("cl-row"),e=i("cl-table"),s=i("cl-pagination"),o=i("cl-upsert"),a=i("cl-crud"),u=i("cl-view-group"),M=Q("permission");return I(),L(u,{ref_key:"ViewGroup",ref:_},{left:p(()=>[n(Ie,{onRefresh:d,onUserAdd:k})]),right:p(()=>[n(a,{ref_key:"Crud",ref:w},{default:p(()=>[n(t,null,{default:p(()=>{var T;return[n(c),n(h),n(F),O((I(),L(q,{type:"success",disabled:((T=v(m))==null?void 0:T.selection.length)==0,onClick:l[0]||(l[0]=z=>b())},{default:p(()=>[G("转移")]),_:1},8,["disabled"])),[[M,v(g).base.sys.user.permission.move]]),n(V),n(E,{placeholder:"搜索用户名、姓名"})]}),_:1}),n(t,null,{default:p(()=>[n(e,{ref_key:"Table",ref:m},{"slot-btn":p(({scope:T})=>[O((I(),L(q,{text:"",bg:"",onClick:z=>b(T.row)},{default:p(()=>[G("转移")]),_:2},1032,["onClick"])),[[M,v(g).base.sys.user.permission.move]])]),_:1},512)]),_:1}),n(t,null,{default:p(()=>[n(V),n(s)]),_:1}),n(o,{ref_key:"Upsert",ref:f},null,512),n(Me,{ref:v($)("userMove")},null,512)]),_:1},512)]),_:1},512)}}});export{_t as default};
