import{l as me}from"./@vue.runtime-dom-592c53ed.js";import{a as fe}from"./vuedraggable-a3421f1a.js";import{Z as ge,J as ve}from"./@element-plus.icons-vue-c499527b.js";import{u as be,i as he,m as ye,x as ke,h as Y}from"./index-1e0489aa.js";import{u as _e}from"./index-eba40255.js";import{p as ee,g as ae,a as te,U as we}from"./index-8ca809a2.js";import{w as oe,v as Se}from"./lodash-es-74a5df03.js";import{a as V}from"./element-plus-7426fe99.js";import{d as re,t as g,q as Ce,X as N,o as d,c as v,a as D,F as le,e as b,K as c,G as J,N as h,J as B,n as se,O as xe,M as Be}from"./@vue.runtime-core-0029b467.js";import{r as ze,u as y}from"./@vue.reactivity-b2e38c7a.js";import{o as ie,O as K}from"./@vue.shared-ccdbf9b9.js";import{_ as Ue}from"./_plugin-vue_export-helper-c27b6911.js";import"./sortablejs-fcb1c1b8.js";import"./chardet-cfd7d38a.js";import"./vue-aac48648.js";import"./@vueuse.core-bf8dfe85.js";import"./@vueuse.shared-501e3e4b.js";import"./store-acb3382e.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./pinia-6d4e9d4f.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-6b15fa8a.js";import"./mockjs-597bdf6e.js";import"./dayjs-20b85df8.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./ts-wps-c1dd0e62.js";const Fe={key:0,class:"cl-upload__demo is-dragger"},Ve={key:1,class:"cl-upload__demo"},Ne={key:0},De={class:"cl-upload__item"},Oe=re({name:"cl-upload"}),$e=re({...Oe,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,autoUpload:{type:Boolean,default:!0},size:[String,Number,Array],icon:null,text:String,showFileList:{type:Boolean,default:!0},draggable:Boolean,drag:Boolean,disabled:Boolean,customClass:String,beforeUpload:Function,isSpace:Boolean,prefixPath:{type:String,default:"app"},menu:{type:String,default:"base"},isEdit:Boolean,scope:Object,prop:String,isDisabled:Boolean},emits:["update:modelValue","upload","success","error","progress"],setup(l,{expose:ne,emit:ue}){me(e=>({"47719a05":X.value[0],"47719a24":X.value[1]}));const o=l,_=ue,{service:O,refs:w,setRefs:$}=_e(),{user:G}=be(),de=he.useForm(),{options:A}=ye.get("upload"),X=g(()=>{const e=o.size||A.size;return(oe(e)?e:[e,e]).map(a=>Se(a)?a+"px":a)}),z=g(()=>o.isDisabled||o.disabled),I=g(()=>z.value||o.isSpace),P=o.limit||A.limit.upload,R=o.limitSize||A.limit.size,q=g(()=>{if(o.text)return o.text;switch(o.type){case"file":return"选择文件";case"image":return"选择图片";default:return""}}),L=g(()=>({Authorization:G.token})),i=ze([]),U=g(()=>o.accept||(o.type=="file"?"":"image/*")),M=g(()=>o.multiple?!z.value&&P-i.value.length>0:i.value.length==0);async function E(e,a){function s(){const t={uid:e.uid,size:e.size,name:e.name,type:te(e.name),progress:o.autoUpload?0:100,url:"",preload:"",error:""};if(t.type=="image"&&e instanceof File&&(t.preload=window.webkitURL.createObjectURL(e)),_("upload",t,e),a)Object.assign(a,t);else if(o.multiple)if(M.value)i.value.push(t);else return V.warning(`最多只能上传${P}个文件`),!1;else i.value=[t];return!0}if(o.beforeUpload){let t=o.beforeUpload(e,a,{next:s});return ke(t)?t.then(s).catch(()=>null):t&&(t=s()),t}else return e.size/1024/1024>=R?(V.error(`上传文件大小不能超过 ${R}MB!`),!1):s()}function Z(e){i.value.splice(e,1),F()}function H(){i.value=[]}async function T(e,a){if(a||(a=i.value.find(t=>t.uid==e.file.uid)),!a)return!1;const s=Y("");try{const{mode:t,type:S}=await O.base.comm.uploadMode(),m=t=="local",u=s+"_"+e.file.name,k=m?u:ee(o.prefixPath,o.menu,u);return new Promise((f,Q)=>{async function C({host:r,preview:ce,data:W}){const x=new FormData;x.append("key",k);for(const n in W)x.has(n)||x.append(n,W[n]);x.append("file",e.file),await O.request({url:r,method:"POST",headers:{"Content-Type":"multipart/form-data",Authorization:m?G.token:null},timeout:6e5,data:x,onUploadProgress(n){a.progress=n.total?Math.floor(n.loaded/n.total*100):0,_("progress",a)},proxy:m,NProgress:!1}).then(n=>{a.key=encodeURIComponent(k),m?a.url=n:a.url=ee(ce||r,a.key),a.fileId=s,_("success",a),f(a.url),F()}).catch(n=>{V.error(n.message),a.error=n.message,_("error",a),Q(n)})}m?C({host:"/admin/base/comm/upload"}):O.base.comm.upload(S=="aws"?{key:k}:{}).then(r=>{switch(S){case"cos":C({host:r.url,data:r.credentials});break;case"oss":C({host:r.host,preview:r.publicDomain,data:{OSSAccessKeyId:r.OSSAccessKeyId,policy:r.policy,signature:r.signature}});break;case"qiniu":C({host:r.uploadUrl,preview:r.publicDomain,data:{token:r.token}});break;case"aws":C({host:r.url,data:r.fields});break}}).catch(Q)})}catch{V.error("上传配置错误")}}function j(){return i.value.find(e=>!e.url)}function F(){if(!j()){const e=ae(i.value);_("update:modelValue",o.multiple?ae(i.value):e[0]),se(()=>{var a,s;o.prop&&((a=de.value)==null||a.validateField(o.prop)),(s=w.upload)==null||s.clearFiles()})}}function pe(e){var a;H(),(a=w.upload)==null||a.clearFiles(),se(()=>{var s,t;(s=w.upload)==null||s.handleStart(e),(t=w.upload)==null||t.submit()})}const p={data:void 0,open(e){var a;p.data=e,(a=w.space)==null||a.open({limit:e||!o.multiple?1:P})},onConfirm(e){p.data?(Object.assign(p.data,e[0]),p.data=void 0):i.value.push(...e),F()}};return Ce(()=>o.modelValue,e=>{if(j())return!1;const a=(oe(e)?e:[e]).filter(Boolean);i.value=a.map((s,t)=>Object.assign({type:te(s),progress:100,uid:Y(),url:s},i.value[t])).filter((s,t)=>o.multiple?!0:t==0)},{immediate:!0}),ne({isAdd:M,list:i,check:j,clear:H,remove:Z,upload:pe}),(e,a)=>{const s=N("el-button"),t=N("el-upload"),S=N("el-icon"),m=N("cl-upload-space");return d(),v(le,null,[D("div",{class:ie(["cl-upload__wrap",[l.customClass]])},[D("div",{class:ie(["cl-upload",[`cl-upload--${l.type}`,{"is-disabled":z.value,"is-drag":l.drag}]])},[l.drag?h("",!0):(d(),v(le,{key:0},[l.type=="file"?(d(),v("div",{key:0,class:"cl-upload__file-btn",onClick:a[0]||(a[0]=u=>p.open())},[b(t,{ref:y($)("upload"),drag:l.drag,action:"",accept:U.value,"show-file-list":!1,"before-upload":E,"http-request":T,headers:L.value,multiple:l.multiple,disabled:I.value},{default:c(()=>[J(e.$slots,"default",{},()=>[b(s,{type:"success"},{default:c(()=>[xe(K(q.value),1)]),_:1})],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):h("",!0)],64)),l.showFileList?(d(),B(y(fe),{key:1,class:"cl-upload__list",tag:"div",modelValue:i.value,"onUpdate:modelValue":a[2]||(a[2]=u=>i.value=u),"ghost-class":"Ghost","drag-class":"Drag",options:{group:"Upload",animation:300,draggable:".is-drag",disabled:!l.draggable},"item-key":"uid",onEnd:F},{footer:c(()=>[(l.type=="image"||l.drag)&&M.value?(d(),v("div",{key:0,class:"cl-upload__footer",onClick:a[1]||(a[1]=u=>p.open())},[b(t,{action:"",drag:l.drag,ref:y($)("upload"),accept:U.value,"show-file-list":!1,"before-upload":E,"http-request":T,headers:L.value,multiple:l.multiple,disabled:I.value},{default:c(()=>[J(e.$slots,"default",{},()=>[l.drag?(d(),v("div",Fe,[b(S,{size:46},{default:c(()=>[b(y(ge))]),_:1}),D("div",null," 点击上传或将文件拖动到此处，文件大小限制"+K(y(R))+"M ",1)])):(d(),v("div",Ve,[b(S,{size:36},{default:c(()=>[l.icon?(d(),B(Be(l.icon),{key:0})):(d(),B(y(ve),{key:1}))]),_:1}),q.value?(d(),v("span",Ne,K(q.value),1)):h("",!0)]))],!0)]),_:3},8,["drag","accept","headers","multiple","disabled"])])):h("",!0)]),item:c(({element:u,index:k})=>[l.showFileList?(d(),B(t,{key:0,class:"is-drag",action:"",accept:U.value,"show-file-list":!1,"http-request":f=>T(f,u),"before-upload":f=>{E(f,u)},headers:L.value,disabled:I.value,onClick:f=>p.open(u)},{default:c(()=>[J(e.$slots,"item",{item:u,index:k},()=>[D("div",De,[b(we,{item:u,list:i.value,disabled:z.value,onRemove:f=>Z(k)},null,8,["item","list","disabled","onRemove"])])],!0)]),_:2},1032,["accept","http-request","before-upload","headers","disabled","onClick"])):h("",!0)]),_:3},8,["modelValue","options"])):h("",!0)],2)],2),l.isSpace?(d(),B(m,{key:0,ref:y($)("space"),"show-btn":!1,accept:U.value,onConfirm:p.onConfirm},null,8,["accept","onConfirm"])):h("",!0)],64)}}});const wa=Ue($e,[["__scopeId","data-v-aa757e33"]]);export{wa as default};
