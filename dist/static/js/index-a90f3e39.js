import{d as se}from"./dayjs-20b85df8.js";import{j as R,u as H,i as L,a as A}from"./index-1e0489aa.js";import"./store-acb3382e.js";import{J as oe,a2 as ne,a3 as ae,a4 as le,B as ce,T as ie,a5 as re,m as ue}from"./@element-plus.icons-vue-c499527b.js";import{A as _e,d as I,t as q,X as c,$ as K,L as W,o as m,c as $,a as e,F as Y,e as t,N as j,K as u,V as X,O as de,n as G,J as F,E as pe}from"./@vue.runtime-core-0029b467.js";import{d as P}from"./pinia-6d4e9d4f.js";import{r as C,u as l}from"./@vue.reactivity-b2e38c7a.js";import{a as me}from"./@vueuse.core-bf8dfe85.js";import{a as ve}from"./element-plus-7426fe99.js";import{O as B,o as J}from"./@vue.shared-ccdbf9b9.js";import{_ as Q}from"./_plugin-vue_export-helper-c27b6911.js";import{u as fe}from"./index-eba40255.js";import{d as he}from"./lodash-es-74a5df03.js";import"./chardet-cfd7d38a.js";import"./@vue.runtime-dom-592c53ed.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-6b15fa8a.js";import"./mockjs-597bdf6e.js";import"./vue-aac48648.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./@vueuse.shared-501e3e4b.js";function Z(){return{chat:_e("chat")}}const ge=P("chat-message",()=>{const v=C(!1),p=C([]),_=C({page:1,total:0,size:20});async function a(i){v.value=!0,(i==null?void 0:i.page)==1&&(p.value=[]),await R.chat.message.page(i).then(f=>{p.value=f.list.map(o=>(o.content=JSON.parse(o.content),o)),_.value=f.pagination}),v.value=!1}return{loading:v,list:p,pagination:_,get:a}}),xe=P("chat-session",()=>{const v=C(!1),p=C([]),_=C();async function a(f){v.value=!0,await R.chat.session.page(f).then(o=>{_.value||i(o.list[0]),p.value=o.list}),v.value=!1}function i(f){_.value=f}return{loading:v,list:p,value:_,get:a,set:i}});function O(){const v=xe(),p=ge();return{session:v,message:p}}const ye={class:"chat-message","element-loading-text":"消息列表加载中"},ke={class:"head"},be={class:"avatar"},$e={class:"name"},Ce={class:"avatar"},we=["onContextmenu"],Me={class:"h"},Se={class:"name"},Te={class:"content"},Ve={key:0,class:"is-text"},Ne={key:1,class:"is-image"},Be={class:"footer"},Ie={class:"tools"},ze={class:"input"},De=I({name:"undefined"}),Ue=I({...De,setup(v){const{user:p}=H(),{chat:_}=Z(),{message:a,session:i}=O(),{copy:f}=me(),o=C(""),w=q(()=>{let d=0;return a.list.map(n=>{var y;return n.contentType==1&&(n._index=d++),n.isMy=n.fromId==((y=p.info)==null?void 0:y.id),n})}),h=q(()=>a.list.filter(d=>d.contentType==1).map(d=>{var n;return(n=d.content)==null?void 0:n.imageUrl}).filter(Boolean));function z(){_.send({contentType:0,content:{text:o.value}},!0),o.value=""}function g(d){_.send({contentType:1,content:{imageUrl:d.url}},!0),o.value=""}function x(d,n){L.ContextMenu.open(d,{hover:{target:"content"},list:[{label:"复制",callback(y){f(n.content.text||""),ve.success("复制成功"),y()}},{label:"转发"},{label:"删除"}]})}return(d,n)=>{var S,k,E,N;const y=c("cl-avatar"),D=c("el-image"),V=c("el-scrollbar"),M=c("el-icon"),U=c("cl-upload"),r=c("el-input"),s=c("el-button"),T=K("loading");return W((m(),$("div",ye,[e("div",ke,[(S=l(i))!=null&&S.value?(m(),$(Y,{key:0},[e("div",be,[t(y,{size:30,shape:"square",src:(k=l(i))==null?void 0:k.value.avatar},null,8,["src"])]),e("span",$e,"与“"+B((E=l(i))==null?void 0:E.value.nickName)+"”聊天中",1)],64)):j("",!0)]),t(V,{class:"list"},{default:u(()=>[e("ul",null,[(m(!0),$(Y,null,X(w.value,(b,ee)=>(m(),$("li",{key:ee},[e("div",{class:J(["item",{"is-right":b.isMy}])},[e("div",Ce,[t(y,{size:36,shape:"square",src:b.avatar},null,8,["src"])]),e("div",{class:"det",onContextmenu:te=>{x(te,b)}},[e("div",Me,[e("span",Se,B(b.nickName),1)]),e("div",Te,[b.contentType==0?(m(),$("div",Ve,[e("span",null,B(b.content.text),1)])):b.contentType==1?(m(),$("div",Ne,[t(D,{src:b.content.imageUrl,"preview-src-list":h.value,"initial-index":b._index,"scroll-container":".chat-message .list"},null,8,["src","preview-src-list","initial-index"])])):j("",!0)])],40,we)],2)]))),128))])]),_:1}),e("div",Be,[e("div",Ie,[e("ul",null,[t(U,{onSuccess:g,"show-file-list":!1},{default:u(()=>[e("li",null,[t(M,null,{default:u(()=>[t(l(oe))]),_:1})])]),_:1}),e("li",null,[t(M,null,{default:u(()=>[t(l(ne))]),_:1})]),e("li",null,[t(M,null,{default:u(()=>[t(l(ae))]),_:1})]),e("li",null,[t(M,null,{default:u(()=>[t(l(le))]),_:1})])])]),e("div",ze,[t(r,{modelValue:o.value,"onUpdate:modelValue":n[0]||(n[0]=b=>o.value=b),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),t(s,{type:"success",onClick:z,disabled:!o.value},{default:u(()=>[de("发送")]),_:1},8,["disabled"])])])])),[[T,(N=l(a))==null?void 0:N.loading]])}}});const Ee=Q(Ue,[["__scopeId","data-v-50781a32"]]),qe={class:"chat-session"},Ye={class:"head"},je={class:"tools"},Fe={class:"list"},Je=["onClick"],Oe={class:"avatar"},Re={class:"det"},He={class:"name"},Le={class:"message"},Ae={class:"status"},Ke={class:"date"},We=I({name:"undefined"}),Xe=I({...We,setup(v){const{browser:p}=A(),{chat:_}=Z(),{session:a,message:i}=O(),{refs:f,setRefs:o}=fe();L.useDialog({onFullscreen(){G(()=>{var g;(g=f.scroller)==null||g.update()})}});const w=C(""),h=q(()=>(a==null?void 0:a.list.filter(g=>{var x;return(x=g.nickName)==null?void 0:x.includes(w.value)}))||[]);async function z(g){p.isMini&&_.expand(!1),a.set(g),await i.get({page:1}),_.scrollToBottom()}return(g,x)=>{var r;const d=c("el-input"),n=c("el-icon"),y=c("cl-avatar"),D=c("el-badge"),V=c("el-empty"),M=c("el-scrollbar"),U=K("loading");return m(),$("div",qe,[e("div",Ye,[t(d,{modelValue:w.value,"onUpdate:modelValue":x[0]||(x[0]=s=>w.value=s),placeholder:"关键字搜索",clearable:""},null,8,["modelValue"]),e("ul",je,[e("li",null,[t(n,null,{default:u(()=>[t(l(ce))]),_:1})]),e("li",{onClick:x[1]||(x[1]=s=>l(a).get())},[t(n,null,{default:u(()=>[t(l(ie))]),_:1})])])]),W((m(),$("div",Fe,[t(M,{class:"scroller",ref:l(o)("scroller")},{default:u(()=>[(m(!0),$(Y,null,X(h.value,(s,T)=>{var S,k;return m(),$("div",{class:J(["item",{"is-active":s.id==((k=(S=l(a))==null?void 0:S.value)==null?void 0:k.id)}]),key:T,onClick:E=>z(s)},[e("div",Oe,[t(D,{value:s.num,hidden:s.num==0},{default:u(()=>[t(y,{shape:"square",src:s.avatar},null,8,["src"])]),_:2},1032,["value","hidden"])]),e("div",Re,[e("p",He,B(s.nickName),1),e("p",Le,B(s.text),1)]),e("div",Ae,[e("p",Ke,B(s.createTime),1)])],10,Je)}),128)),h.value.length==0?(m(),F(V,{key:0,"image-size":100,description:"暂无会话"})):j("",!0)]),_:1},512)])),[[U,(r=l(a))==null?void 0:r.loading]])])}}});const Ge=Q(Xe,[["__scopeId","data-v-490e6747"]]),Pe={class:"cl-chat__wrap"},Qe={class:"cl-chat__session"},Ze={class:"cl-chat__right"},et={class:"cl-dialog__controls-icon"},tt=I({name:"cl-chat"}),jt=I({...tt,setup(v,{expose:p}){const{browser:_,onScreenChange:a}=A(),{session:i,message:f}=O(),{user:o}=H(),w=C(!1),h=C(!0),z=C(parseInt(String(Math.random()*100)));let g;function x(){U()}function d(){w.value=!0,x()}function n(){w.value=!1}function y(r){h.value=r===void 0?!h.value:r}function D(r,s){s&&V(r)}function V(r){var s,T,S,k;f.list.push({fromId:(s=o.info)==null?void 0:s.id,toId:(T=i.value)==null?void 0:T.userId,avatar:(S=o.info)==null?void 0:S.headImg,nickName:(k=o.info)==null?void 0:k.nickName,createTime:se().format("YYYY-MM-DD HH:mm:ss"),...r}),M()}const M=he(()=>{G(()=>{const r=document.querySelector(".cl-chat .chat-message .list");r==null||r.scroll({top:1e5+Math.random(),behavior:"smooth"})})},300);async function U(){await i.get(),await f.get(),M()}return pe("chat",{get socket(){return g},send:D,append:V,expand:y,scrollToBottom:M}),a(()=>{h.value=!_.isMini}),p({open:d,close:n}),(r,s)=>{const T=c("cl-svg"),S=c("el-badge"),k=c("el-icon"),E=c("cl-dialog");return m(),$("div",Pe,[t(S,{value:z.value},{default:u(()=>[e("div",{class:"cl-chat__icon",onClick:d},[t(T,{name:"icon-notice",size:16})])]),_:1},8,["value"]),t(E,{modelValue:w.value,"onUpdate:modelValue":s[2]||(s[2]=N=>w.value=N),title:"聊天窗口",height:"700px",width:"1200px",padding:"0","keep-alive":"","close-on-click-modal":!1,"close-on-press-escape":"",controls:["slot-expand","cl-flex1","fullscreen","close"]},{"slot-expand":u(()=>[e("button",et,[h.value?(m(),F(k,{key:1,onClick:s[1]||(s[1]=N=>h.value=!1)},{default:u(()=>[t(l(ue))]),_:1})):(m(),F(k,{key:0,onClick:s[0]||(s[0]=N=>h.value=!0)},{default:u(()=>[t(l(re))]),_:1}))])]),default:u(()=>[e("div",{class:J(["cl-chat",{"is-mini":l(_).isMini,"is-expand":h.value}])},[e("div",Qe,[t(Ge)]),e("div",Ze,[t(Ee)])],2)]),_:1},8,["modelValue"])])}}});export{jt as default};
