import{i as k,t as B}from"./index-1e0489aa.js";import{d as N}from"./dayjs-20b85df8.js";import{F as W}from"./file-saver-6092abb0.js";import{u as y,w as Y}from"./xlsx-175ecd87.js";import{q as j,x as D}from"./lodash-es-74a5df03.js";import{a as w}from"./element-plus-7426fe99.js";import{d as L,e as E,X as A}from"./@vue.runtime-core-0029b467.js";import{r as M}from"./@vue.reactivity-b2e38c7a.js";import"./@vue.runtime-dom-592c53ed.js";import"./@vue.shared-ccdbf9b9.js";import"./@vueuse.core-bf8dfe85.js";import"./@vueuse.shared-501e3e4b.js";import"./store-acb3382e.js";import"./chardet-cfd7d38a.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./pinia-6d4e9d4f.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-6b15fa8a.js";import"./mockjs-597bdf6e.js";import"./vue-aac48648.js";import"./@element-plus.icons-vue-c499527b.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";function T(e,u){for(var n={},r={s:{c:1e7,r:1e7},e:{c:0,r:0}},a=0;a!=e.length;++a)for(var c=0;c!=e[a].length;++c){r.s.r>a&&(r.s.r=a),r.s.c>c&&(r.s.c=c),r.e.r<a&&(r.e.r=a),r.e.c<c&&(r.e.c=c);var f={v:e[a][c]};if(f.v!=null){var d=y.encode_cell({c,r:a});f.t="s",n[d]=f}}return r.s.c<1e7&&(n["!ref"]=y.encode_range(r)),n}function b(){if(!(this instanceof b))return new b;this.SheetNames=[],this.Sheets={}}function $(e){for(var u=new ArrayBuffer(e.length),n=new Uint8Array(u),r=0;r!=e.length;++r)n[r]=e.charCodeAt(r)&255;return u}function q({multiHeader:e=[],header:u,data:n,filename:r,merges:a=[],autoWidth:c=!0,bookType:f="xlsx"}={}){r=r||"excel-list",n=[...n],n.unshift(u);for(let o=e.length-1;o>-1;o--)n.unshift(e[o]);var d="SheetJS",v=new b,p=T(n);if(a.length>0&&(p["!merges"]||(p["!merges"]=[]),a.forEach(o=>{p["!merges"].push(y.decode_range(o))})),c){const o=n.map(l=>l.map(i=>i==null?{wch:10}:i.toString().charCodeAt(0)>255?{wch:i.toString().length*2}:{wch:i.toString().length}));let t=o[0];for(let l=1;l<o.length;l++)for(let i=0;i<o[l].length;i++)t[i].wch<o[l][i].wch&&(t[i].wch=o[l][i].wch);p["!cols"]=t}v.SheetNames.push(d),v.Sheets[d]=p;var m=Y(v,{bookType:f,bookSST:!1,type:"binary"});W.saveAs(new Blob([$(m)],{type:"application/octet-stream"}),`${r}.${f}`)}const Se=L({name:"cl-export-btn",props:{filename:[Function,String],autoWidth:{type:Boolean,default:!0},bookType:{type:String,default:"xlsx"},header:Array,columns:{type:Array},data:[Function,Array],maxExportLimit:Number},setup(e,{slots:u}){const n=k.useCrud(),r=k.useForm(),a=M(!1);async function c(m,o){return m.filter(t=>!t.hidden&&o.includes(t.prop)).map(t=>t.label)}async function f(){var o,t,l;const m={...(o=n.value)==null?void 0:o.paramsReplace(n.value.params),maxExportLimit:e.maxExportLimit,isExport:!0};return typeof e.data=="function"?e.data(m):e.data?e.data:(t=n.value)!=null&&t.service?(l=n.value)==null?void 0:l.service.page(m).then(i=>i.list.map((s,x)=>{var S,_;for(const h in s){const g=(S=e.columns)==null?void 0:S.find(F=>F.prop==h);g&&(g.formatter&&(s[h]=g.formatter(s,g,s[h],x)),g.dict&&(s[h]=((_=B(s[h],g.dict))==null?void 0:_.label)||s[h]))}return s})).catch(i=>(w.error(i.message),[])):[]}async function d(){return typeof e.filename=="function"?await(e==null?void 0:e.filename()):e.filename||`报表（${N().format("YYYY-MM-DD HH_mm_ss")}）`}async function v(m){a.value=!0;const o=m.map(s=>s.prop).filter(Boolean),t=await c(m,o);let l=await f();if(!l)return a.value=!1,w.error("导出数据异常");const i=await d();l=l.map(s=>o.map(x=>s[x])),q({header:t,data:l,filename:i,autoWidth:e.autoWidth,bookType:e.bookType}),a.value=!1}function p(){var o;if(!e.columns)return;const m=j(e.columns,"orderNum","asc").filter(t=>!(t.hidden===!0||["selection","expand","index","op"].includes(t.type)||t.filterExport||t["filter-export"]));(o=r.value)==null||o.open({title:"导出",width:"600px",props:{labelPosition:"top"},form:{checked:m.map(t=>t.prop)},items:[{label:"选择列",prop:"checked",component:{name:"el-checkbox-group",options:m.map(t=>({label:String(t.label),value:t.prop}))}}],on:{submit(t,{close:l,done:i}){D(t.checked)?(w.warning("请先选择要导出的列"),i()):(v(m.filter(s=>t.checked.includes(s.prop))),l())}}})}return()=>E(A("el-button"),{loading:a.value,onClick:p},{default:()=>[u.default?u.default():"导出",E(A("cl-form"),{ref:r},null)]})}});export{Se as default};
