import{i as U,d as B,m as G,b as D,c as Q,e as Y}from"./index-1e0489aa.js";import{u as S}from"./index-eba40255.js";import{R as Z,S as ee}from"./@element-plus.icons-vue-c499527b.js";import"./store-acb3382e.js";import{q as te,x as L}from"./lodash-es-74a5df03.js";import{a as C}from"./element-plus-7426fe99.js";import{d as v,X as s,o as u,c as x,e as a,K as p,O as F,F as I,t as oe,f as ne,J as A,N as K,V as q,$ as le,L as re}from"./@vue.runtime-core-0029b467.js";import{r as ae,u as E}from"./@vue.reactivity-b2e38c7a.js";import{d as se}from"./dayjs-20b85df8.js";import{u as pe}from"./menu-2aaab429.js";import"./socket.io-client-c7af6a83.js";import{O as j}from"./@vue.shared-ccdbf9b9.js";import{_ as ie}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vue.runtime-dom-592c53ed.js";import"./@vueuse.core-bf8dfe85.js";import"./@vueuse.shared-501e3e4b.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-6d4e9d4f.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./vue-router-6b15fa8a.js";import"./mockjs-597bdf6e.js";import"./vue-aac48648.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./engine.io-client-0a8b97a6.js";import"./engine.io-parser-b13552ae.js";import"./@socket.io.component-emitter-3e1df240.js";import"./socket.io-parser-bc267b40.js";const ce=v({name:"undefined"}),ue=v({...ce,setup($){const{service:b}=S(),w=U.useForm(),g=U.useCrud(),m=ae(!1);function f(y,h){m.value=!0;const d=new FileReader;d.onload=r=>{var n,e;m.value=!1;try{const t=JSON.parse((n=r.target)==null?void 0:n.result);(e=w.value)==null||e.open({title:"菜单导入",height:"400px",width:"600px",props:{labelWidth:"0px"},op:{saveButtonText:"添加"},items:[{component:{name:"slot-tips"}},{component:{name:"el-tree",props:{data:te(t,"orderNum","asc"),nodeKey:"name",props:{label:"name",children:"childMenus"},renderContent(o,{data:_}){return _.name}},style:{padding:"5px",borderRadius:"var(--el-border-radius-base)",border:"1px solid var(--el-border-color)"}}}],on:{submit(o,{close:_,done:c}){b.base.sys.menu.import({menus:t}).then(()=>{var i;C.success("导入成功"),(i=g.value)==null||i.refresh(),_()}).catch(i=>{C.error(i.message),c()})}}})}catch(t){C.error(`${h.name}文件格式错误：${t}`)}},d.readAsText(h)}return(y,h)=>{const d=s("el-button"),r=s("cl-upload"),n=s("el-alert"),e=s("cl-form");return u(),x(I,null,[a(r,{type:"file","show-file-list":!1,"auto-upload":!1,disabled:m.value,onUpload:f},{default:p(()=>[a(d,{type:"success",icon:E(Z),loading:m.value},{default:p(()=>[F("导入")]),_:1},8,["icon","loading"])]),_:1},8,["disabled"]),a(e,{ref_key:"Form",ref:w},{"slot-tips":p(()=>[a(n,{type:"warning"},{default:p(()=>[F("如遇到问题无法导入菜单，请检查文件并尝试重新导入。")]),_:1})]),_:1},512)],64)}}}),me=v({name:"undefined"}),de=v({...me,props:{data:{type:Array,default:()=>[]}},setup($){const b=$,{service:w,refs:g,setRefs:m}=S(),f=U.useForm();function y(){var h;(h=f.value)==null||h.open({title:"导出",width:"600px",props:{labelPosition:"top"},items:[{label:"选择菜单",prop:"ids",component:{name:"el-tree-select",ref:m("ids"),props:{data:b.data,nodeKey:"id",multiple:!0,showCheckbox:!0,collapseTags:!0,collapseTagsTooltip:!0,props:{label:"name"}}}}],on:{submit(d,{done:r,close:n}){const e=[...g.ids.getCheckedKeys(),...g.ids.getHalfCheckedKeys()];L(e)?(C.warning("请先选择要导出的菜单"),r()):w.base.sys.menu.export({ids:e}).then(t=>{n();const o=new Blob([JSON.stringify(t)],{type:"application/json"}),_=URL.createObjectURL(o),c=document.createElement("a");c.href=_,c.download=`菜单数据 ${se().format("MM-DD HH_mm_ss")}.json`,c.click(),URL.revokeObjectURL(_)}).catch(t=>{C.error(t.message)})}}})}return(h,d)=>{const r=s("el-button"),n=s("cl-form");return u(),x(I,null,[a(r,{type:"info",icon:E(ee),onClick:y},{default:p(()=>[F("导出")]),_:1},8,["icon"]),a(n,{ref_key:"Form",ref:f},null,512)],64)}}}),_e=v({name:"menu-create"}),fe=v({..._e,setup($){const{service:b,mitt:w}=S(),g=pe(),m=U.useForm(),f=[],y=oe(()=>B(f.map(r=>r.value)));function h(){var r;(r=m.value)==null||r.open({title:"快速创建",width:"800px",items:[{prop:"module",label:"选择模块",span:10,component:{name:"cl-select",props:{filterable:!0,clearable:!0,placeholder:"请选择模块",allowCreate:!0,defaultFirstOption:!0,options:G.dirs}},required:!0},{prop:"entity",label:"数据结构",span:14,component:{name:"slot-entity"},required:!0},{prop:"name",label:"菜单名称",span:10,component:{name:"el-input",props:{placeholder:"请输入菜单名称"}},required:!0},{prop:"router",label:"菜单路由",span:14,component:{name:"el-input",props:{placeholder:"请输入菜单路由，如：/test"}},rules:{required:!0,validator(n,e,t){(e||"").startsWith("/")?t():t(new Error("必须以 / 开头"))}}},{prop:"parentId",label:"上级节点",component:{name:"cl-menu-select",props:{type:1}}},{prop:"keepAlive",value:!0,label:"路由缓存",component:{name:"el-radio-group",options:[{label:"开启",value:!0},{label:"关闭",value:!1}]}},{prop:"icon",label:"菜单图标",component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序号",component:{name:"el-input-number",props:{placeholder:"请填写排序号",min:0,max:99,"controls-position":"right"}}},{prop:"isCreateFile",label:"是否创建文件",value:1,component:{name:"el-radio-group",options:[{label:"是",value:1},{label:"否",value:0}]}}],on:{submit(n,{done:e,close:t}){const{api:o,prefix:_,columns:c}=f.find(i=>i.value==n.entity.join("/"));g.create({...n,router:n.router,module:n.module,prefix:_,api:o,columns:c}).then(i=>{n.isCreateFile&&i(),w.emit("magic.createMenu"),t()}).catch(i=>{e()})}}})}function d(r){var e;const n=f.find(t=>t.value==r.join("/"));n&&((e=m.value)==null||e.setForm("router",`/${n.value}`))}return ne(()=>{b.base.open.eps().then(r=>{for(const n in r)r[n].forEach(e=>{L(e.columns)||f.push({value:e.prefix.substring(7),...e})})})}),(r,n)=>{const e=s("el-button"),t=s("el-cascader"),o=s("cl-form");return u(),x(I,null,[a(e,{type:"success",onClick:h},{default:p(()=>[F("快速创建")]),_:1}),a(o,{ref_key:"Form",ref:m},{"slot-entity":p(({scope:_})=>[a(t,{modelValue:_.entity,"onUpdate:modelValue":c=>_.entity=c,filterable:"",separator:".",options:y.value,onChange:d},null,8,["modelValue","onUpdate:modelValue","options"])]),_:1},512)],64)}}}),be=v({name:"auto-menu"}),he=v({...be,setup($){return(b,w)=>E(D)?(u(),A(fe,{key:0})):K("",!0)}}),ye=v({name:"auto-perms"}),ve=v({...ye,props:{menuId:[String,Number]},emits:["open","close"],setup($,{emit:b}){const w=$,g=b,{service:m}=S(),f=U.useForm();async function y(){return m.base.open.eps().then(d=>{const r=[],n=[];for(const e in d)d[e].forEach(t=>{var o;t.prefix=(o=t.prefix)==null?void 0:o.replace("/admin/",""),t.prefix&&n.push(t.prefix),r.push(t)});return{prop:"entity",label:"实体数据",component:{name:"el-cascader",props:{options:B(n),separator:".",props:{multiple:!0},onChange(e){var o;const t=[];e.forEach(_=>{const c=r.find(i=>i.prefix==_.join("/"));c&&(c.api.forEach(i=>{i.perms=(c.prefix+i.path).replace(/\//g,":"),i.checked=!0}),t.push(c))}),(o=f.value)==null||o.setForm("list",t)}}}}})}async function h(){var d;g("open"),(d=f.value)==null||d.open({title:"自动添加权限",width:"800px",dialog:{draggable:!0,controls:["close"]},props:{labelPosition:"top"},op:{saveButtonText:"一键添加"},items:[await y(),{prop:"list",label:"权限列表",value:[],hidden({scope:r}){return!r.entity},component:{name:"slot-list"}}],on:{submit(r,{done:n,close:e}){if(!r.entity){C.error("请选择实体数据"),n();return}const t=r.list.map(o=>o.api).flat().filter(o=>o.checked);if(t.find(o=>!o.summary)){C.error("请填写权限名称"),n();return}if(t.length==0){C.error("请至少选择一个权限"),n();return}Promise.all(t.map(o=>m.base.sys.menu.add({type:2,parentId:w.menuId,name:o.summary,perms:o.perms}))).then(()=>{C.success("添加权限成功"),e(),g("close")}).catch(o=>{n(),C.error(o.message)})}}})}return(d,r)=>{const n=s("el-button"),e=s("el-divider"),t=s("el-switch"),o=s("el-input"),_=s("cl-menu-perms"),c=s("el-scrollbar"),i=s("cl-form");return u(),x(I,null,[E(D)?(u(),A(n,{key:0,onClick:h,style:{"margin-left":"10px"}},{default:p(()=>[F("自动添加")]),_:1})):K("",!0),a(i,{ref_key:"Form",ref:f},{"slot-list":p(({scope:N})=>[a(c,{class:"scrollbar"},{default:p(()=>[(u(!0),x(I,null,q(N.list,(R,M)=>(u(),x("div",{class:"list",key:M},[a(e,{"content-position":"left"},{default:p(()=>[F(j(R.prefix),1)]),_:2},1024),(u(!0),x(I,null,q(R.api,(k,O)=>(u(),x("div",{class:"item",key:O},[a(t,{modelValue:k.checked,"onUpdate:modelValue":T=>k.checked=T},null,8,["modelValue","onUpdate:modelValue"]),a(o,{modelValue:k.summary,"onUpdate:modelValue":T=>k.summary=T,clearable:"",placeholder:"权限名称",disabled:!k.checked},null,8,["modelValue","onUpdate:modelValue","disabled"]),a(_,{modelValue:k.perms,"onUpdate:modelValue":T=>k.perms=T,disabled:!k.checked},null,8,["modelValue","onUpdate:modelValue","disabled"])]))),128))]))),128))]),_:2},1024)]),_:1},512)],64)}}});const we=ie(ve,[["__scopeId","data-v-329dcb9b"]]),ge={key:1},xe={key:1},ke={key:1},Ve=v({name:"sys-menu"}),_t=v({...Ve,setup($){const{service:b,mitt:w}=S(),{menu:g}=Q(),m=U.useTable({contextMenu:[e=>({label:"新增",hidden:!(e.type!=2&&b.base.sys.user._permission.add),callback(t){r(e),t()}}),"update","delete",e=>({label:"权限",hidden:!(e.type!=2&&b.base.sys.user._permission.add),callback(t){n(e),t()}})],columns:[{type:"selection"},{prop:"name",label:"名称",align:"left",width:200,fixed:"left"},{prop:"isShow",label:"是否显示",width:100},{prop:"icon",label:"图标",width:100},{prop:"type",label:"类型",width:100,dict:[{label:"目录",value:0,type:"warning"},{label:"菜单",value:1,type:"success"},{label:"权限",value:2,type:"danger"}]},{prop:"router",label:"节点路由",minWidth:160},{prop:"keepAlive",label:"路由缓存",width:100},{prop:"viewPath",label:"文件路径",minWidth:200,showOverflowTooltip:!0},{prop:"perms",label:"权限",headerAlign:"center",minWidth:300,dict:[]},{prop:"orderNum",label:"排序号",width:90,fixed:"right"},{prop:"updateTime",label:"更新时间",sortable:"custom",width:160},{label:"操作",type:"op",width:250,buttons:["slot-add","edit","delete"]}]}),f=U.useUpsert({dialog:{width:"800px"},items:[{prop:"type",value:0,label:"节点类型",required:!0,component:{name:"el-radio-group",options:[{label:"目录",value:0},{label:"菜单",value:1},{label:"权限",value:2}]}},{prop:"name",label:"节点名称",component:{name:"el-input"},required:!0},{prop:"parentId",label:"上级节点",hook:{submit(e){return e===""?null:e}},component:{name:"slot-parentId"}},{prop:"router",label:"节点路由",hidden:({scope:e})=>e.type!=1,component:{name:"el-input",props:{placeholder:"请输入节点路由，如：/test"}}},{prop:"keepAlive",value:!0,label:"路由缓存",hidden:({scope:e})=>e.type!=1,component:{name:"el-radio-group",options:[{label:"开启",value:!0},{label:"关闭",value:!1}]}},{prop:"isShow",label:"是否显示",value:!0,hidden:({scope:e})=>e.type==2,flex:!1,component:{name:"el-switch"}},{prop:"viewPath",label:"文件路径",hidden:({scope:e})=>e.type!=1,component:{name:"cl-menu-file"}},{prop:"icon",label:"节点图标",hidden:({scope:e})=>e.type==2,component:{name:"cl-menu-icon"}},{prop:"orderNum",label:"排序号",component:{name:"el-input-number",props:{placeholder:"请填写排序号",min:0,max:99,"controls-position":"right"}}},{prop:"perms",label:"权限",hidden:({scope:e})=>e.type!=2,component:{name:"slot-perms"}}],plugins:[U.setFocus("name")]}),y=U.useCrud({service:b.base.sys.menu,onRefresh(e,{render:t}){b.base.sys.menu.list().then(o=>{t(Y(o)),g.get()})}},e=>{e.refresh()});function h(e){var t;(t=y.value)==null||t.refresh(e)}function d(e,t){var o;t!=null&&t.property&&e.children&&((o=m.value)==null||o.toggleRowExpansion(e))}function r({type:e,id:t}){var o;(o=y.value)==null||o.rowAppend({parentId:t,parentType:e,type:e+1,keepAlive:!0,isShow:!0})}function n({id:e}){var t;(t=y.value)==null||t.rowAppend({parentId:e,type:2})}return w.on("magic.createMenu",h),(e,t)=>{const o=s("cl-refresh-btn"),_=s("cl-add-btn"),c=s("cl-multi-delete-btn"),i=s("cl-flex1"),N=s("cl-row"),R=s("cl-svg"),M=s("cl-switch"),k=s("el-link"),O=s("el-button"),T=s("cl-table"),W=s("cl-menu-select"),H=s("cl-menu-perms"),J=s("cl-upsert"),z=s("cl-crud"),X=le("permission");return u(),A(z,{ref_key:"Crud",ref:y},{default:p(()=>[a(N,null,{default:p(()=>{var l;return[a(o),a(_),a(c),a(he),a(i),a(ue),a(de,{data:(l=E(m))==null?void 0:l.data},null,8,["data"])]}),_:1}),a(N,null,{default:p(()=>[a(T,{ref_key:"Table",ref:m,"row-key":"id",onRowClick:d},{"column-icon":p(({scope:l})=>[a(R,{name:l.row.icon,size:"16px",style:{"margin-top":"5px"}},null,8,["name"])]),"column-isShow":p(({scope:l})=>[l.row.type!=2?(u(),A(M,{key:0,modelValue:l.row.isShow,"onUpdate:modelValue":V=>l.row.isShow=V,"active-value":!0,"inactive-value":!1,scope:l.row,column:l.column},null,8,["modelValue","onUpdate:modelValue","scope","column"])):(u(),x("span",ge))]),"column-keepAlive":p(({scope:l})=>[l.row.type==1?(u(),A(M,{key:0,modelValue:l.row.keepAlive,"onUpdate:modelValue":V=>l.row.keepAlive=V,"active-value":!0,"inactive-value":!1,scope:l.row,column:l.column},null,8,["modelValue","onUpdate:modelValue","scope","column"])):(u(),x("span",xe))]),"column-router":p(({scope:l})=>[l.row.type==1?(u(),A(k,{key:0,type:"success",href:l.row.router},{default:p(()=>[F(j(l.row.router),1)]),_:2},1032,["href"])):(u(),x("span",ke,j(l.row.router),1))]),"slot-add":p(({scope:l})=>[re((u(),A(O,{type:"success",text:"",bg:"",onClick:V=>r(l.row)},{default:p(()=>[F("新增")]),_:2},1032,["onClick"])),[[X,{and:[E(b).base.sys.menu.permission.add,l.row.type!=2]}]])]),_:1},512)]),_:1}),a(J,{ref_key:"Upsert",ref:f},{"slot-parentId":p(({scope:l})=>[a(W,{modelValue:l.parentId,"onUpdate:modelValue":V=>l.parentId=V,type:l.type},null,8,["modelValue","onUpdate:modelValue","type"])]),"slot-perms":p(({scope:l})=>[a(H,{modelValue:l.perms,"onUpdate:modelValue":V=>l.perms=V},null,8,["modelValue","onUpdate:modelValue"]),a(we,{"menu-id":l.parentId,onOpen:t[0]||(t[0]=V=>{var P;return(P=E(f))==null?void 0:P.close()}),onClose:t[1]||(t[1]=V=>h())},null,8,["menu-id"])]),_:1},512)]),_:1},512)}}});export{_t as default};
