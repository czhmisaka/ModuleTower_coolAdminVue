import{u as $,i as ee}from"./index-1e0489aa.js";import{a as te}from"./@vueuse.core-bf8dfe85.js";import{m as oe}from"./mqtt-ec323294.js";import"./store-acb3382e.js";import{u as Z}from"./index-eba40255.js";import{d as se}from"./dayjs-20b85df8.js";import{o as ne}from"./vue-router-6b15fa8a.js";import{q as ae,d as ie}from"./lodash-es-74a5df03.js";import{a as X}from"./element-plus-7426fe99.js";import{d as j,t as re,n as S,am as ce,X as p,$ as le,o as A,J as ue,K as C,a as s,e as m,L as pe,c as w,F as me,V as de,N as ve,O as _e}from"./@vue.runtime-core-0029b467.js";import{u as Ae}from"./hook-6b6f6a66.js";import{r as E,u as d}from"./@vue.reactivity-b2e38c7a.js";import{O as f,o as M}from"./@vue.shared-ccdbf9b9.js";import{_ as fe}from"./_plugin-vue_export-helper-c27b6911.js";import"./@vue.runtime-dom-592c53ed.js";import"./mitt-b509fb6d.js";import"./axios-f6771985.js";import"./nprogress-5ff42f71.js";import"./chardet-cfd7d38a.js";import"./pinia-6d4e9d4f.js";import"./monaco-editor-f913c445.js";import"./vue-echarts-8be4a346.js";import"./resize-detector-a5205554.js";import"./echarts-eea5b079.js";import"./tslib-54e39b60.js";import"./zrender-ecf5ed03.js";import"./mockjs-597bdf6e.js";import"./vue-aac48648.js";import"./@element-plus.icons-vue-c499527b.js";import"./@popperjs.core-c75af06c.js";import"./@ctrl.tinycolor-f8748455.js";import"./async-validator-8a4f889d.js";import"./memoize-one-297ddbcb.js";import"./escape-html-f47942fe.js";import"./normalize-wheel-es-ed76fb12.js";import"./@floating-ui.dom-4390772d.js";import"./@floating-ui.core-1d013f45.js";import"./@floating-ui.utils-1e4a7d10.js";import"./@vueuse.shared-501e3e4b.js";let t;function ge(){const{mitt:q}=Z();function r(a,c){t==null||t.publish(a,c)}function v(a){t==null||t.subscribe(`${a}@admin`,function(c){})}function b(){_(),t=oe.connect("ws://127.0.0.1:8083"),t&&(t.on("connect",function(){}),t.on("message",function(a,c){q.emit("iot.message",{id:a.split("@")[0],message:c.toString()})}),t.on("error",function(a){t==null||t.reconnect()}))}function _(){t==null||t.end()}return{client:t,connect:b,disconnect:_,subscribe:v,send:r}}const L="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAA19JREFUeF7tmcvrTVEUxz/fEv4Bj5RkQEoZCBlIpDxiQt7JQPL6JY/ERHnEQJgoZCDJM68oykD8zA1MUDKRCZmZyWBp6dw6jnPvPWdf19m6ew3vWfusvT77u9Y+d28x4KYBz58EIClgwAmkEhhwAaQmmEoglcCAE0glMOAC6G0XMLNLwAJgakMg3wPDkraHxg8uATOz0KD9GCcpKJegQWZ2FDjSj0R6eOcxST6vWhYK4Bawvlak/jvflrShbphQAC+y2q8br5P/XeAecAKYEvBi7wUL646LCcBCScNmNhpwKR+qmUx0ALYBK4FlFRK5IGko72dmc4FjwOIK490lKgBPJK3wWZnZKmAXsKhNIl+9nCS9LXtuZjuA48CYLiCiArBM0tPCinrT3AnMLyTStXub2TRgL9Bpv48GwCVJvmqlZmabMxAu8TeA176r4JeZ2ThJX9qowSHuA+aUPI8CgE98nqQP3erWzLYCIyVdyCU/CngIPJN0tg2E8cAe4AAwIucTBYDDkk4WpL9J0vVuQLLVPwicynxfA2ck3WgDYilwFRibPW8cwCtJswvJ+07g/xduu3Qlfe5QGrOAR8CEgo/3ktOSnhfefQ7YHZMCVku6n5PzJOAJMD377RuwX9LlNit6DdjUQSlXMhDvzGwJ8FuTbXobvCNpXWGFvIb3lyT0IAPxMQdrC1AKpjD+h5cFMBNwCHlrtAS8kZ1v7eXZCj0uNKn8ZL9nJXHRzCZnjW9GlT7RwadRAD4v38r8i+6omXnyyysk5CXiO4Z39V6tcQCtBHxvb9V9r0nVGR8NgDqT/pu+CcD//ne4VzX8UwX4QWh05ucJdScVdCBSN0jM/kEAzGywFWBm/TgT7FUo/7QHJAB9OBVOCuiRQKMl4NvPy4oJVLlSK97w+Olwy1rjvRHnm3GzAEK+wsqAZTuM95i8/XFwWtKIE4CQRQj9DijuAkH0kwJKCPy3JVCxAVZ1K35ptvvGb6wJ+hGY3/LEZBcl+RVcLQvtAR7ofK1I/Xceyl+yVA0XBMBfbmZ3gDVVA/XZ766ktSExggFkEDYCfkMzMST4Xxjzye8HJN0MfVdPAEKDxjQuAYhpNZqYS1JAE9RjipkUENNqNDGXpIAmqMcUMykgptVoYi5JAU1QjynmT+PCelBN7E0UAAAAAElFTkSuQmCC",he={class:"icon"},Ce={class:"det"},we={class:"name"},be={class:"text"},ye={class:"message"},xe={class:"icon"},Ve=["onContextmenu"],ke={class:"content"},Be={class:"is-text"},Ee={class:"date"},Me={key:0,class:"empty"},qe={class:"footer"},De={class:"input"},Je=j({name:"iot-device"}),Re=j({...Je,setup(q){const{service:r,refs:v,setRefs:b,mitt:_}=Z(),{copy:a}=te(),{user:c}=$(),y=ge(),{ViewGroup:x}=Ae({label:"设备",title:"消息列表",service:r.iot.device,onEdit(e){return{width:"600px",items:[{label:"设备名称",prop:"name",component:{name:"el-input",props:{maxlength:20,clearable:!0}},required:!0},{label:"设备ID",prop:"uniqueId",component:{name:"el-input",props:{maxlength:30,clearable:!0,disabled:!!(e!=null&&e.id)}},required:!0},{label:"设备图标",prop:"icon",component:{name:"cl-upload"}}]}},async onSelect(e){y.subscribe(e.uniqueId),await R({page:1,deviceId:e.id}),T()}}),V=E(!1),l=E(""),u=E([]),D=re(()=>{var e,o;return(o=(e=x.value)==null?void 0:e.selected)==null?void 0:o.uniqueId}),g={page:1,size:20};let J=!1;async function R(e){await r.iot.mqtt.config(),V.value=!0,Object.assign(g,{order:"createTime",sort:"desc",...e}),await r.iot.message.page(g).then(o=>{const i=ae(o.list,"createTime");if(g.page==1)u.value=i;else{const h=v.scrollbar.wrapRef.querySelector("ul"),k=h.clientHeight;u.value.unshift(...i),S(()=>{v.scrollbar.scrollTo(0,h.clientHeight-k)})}J=o.pagination.total<=u.value.length}).catch(o=>{X.error(o.message)}),V.value=!1}const T=ie(()=>{S(()=>{var e,o;(o=(e=v.scrollbar)==null?void 0:e.wrapRef)==null||o.scroll({top:1e5+Math.random(),behavior:"smooth"})})});function Y({scrollTop:e}){e==0&&!J&&R({page:g.page+1})}function z(){r.iot.mqtt.publish({uniqueId:D.value,data:l.value}).then(()=>{I({data:l.value,type:0}),l.value=""})}function I(e){u.value.push({createTime:new Date,...e}),T()}function P(e,o){ee.ContextMenu.open(e,{hover:{target:"content"},list:[{label:"复制",callback(i){a(o.data||""),X.success("复制成功"),i()}}]})}function G({id:e,message:o}){D.value==e&&I({type:1,data:o})}return ce(()=>{y.connect(),_.on("iot.message",G)}),ne(()=>{y.disconnect(),_.off("iot.message")}),(e,o)=>{const i=p("cl-avatar"),h=p("el-empty"),k=p("el-scrollbar"),F=p("el-input"),U=p("el-button"),H=p("cl-view-group"),O=le("loading");return A(),ue(H,{ref_key:"ViewGroup",ref:x},{item:C(({item:n,selected:B})=>[s("div",{class:M(["device-item",{"is-active":B.id==n.id}])},[s("div",he,[m(i,{shape:"square",src:n.icon||d(L)},null,8,["src"])]),s("div",Ce,[s("p",we,f(n.name),1),s("p",be,f(n.uniqueId),1)]),s("div",{class:M(["status",{"is-on":n.status}])},f(n.status?"在线":"离线"),3)],2)]),right:C(()=>[pe((A(),w("div",ye,[m(k,{class:"list",ref:d(b)("scrollbar"),onScroll:Y},{default:C(()=>[s("ul",null,[(A(!0),w(me,null,de(u.value,(n,B)=>{var K,N,Q;return A(),w("li",{key:B},[s("div",{class:M(["item",{"is-right":n.type==0}])},[s("div",xe,[m(i,{size:36,shape:"square",src:n.type==0?(K=d(c).info)==null?void 0:K.headImg:((Q=(N=d(x))==null?void 0:N.selected)==null?void 0:Q.icon)||d(L)},null,8,["src"])]),s("div",{class:"det",onContextmenu:W=>{P(W,n)}},[s("div",ke,[s("span",Be,f(n.data),1)]),s("div",Ee,f(d(se)(n.createTime).format("YYYY-MM-DD HH:mm:ss")),1)],40,Ve)],2)])}),128))]),u.value.length==0?(A(),w("div",Me,[m(h,{"image-size":100,description:"暂无消息"})])):ve("",!0)]),_:1},512),s("div",qe,[s("div",De,[m(F,{modelValue:l.value,"onUpdate:modelValue":o[0]||(o[0]=n=>l.value=n),type:"textarea",rows:4,resize:"none",autosize:{minRows:4,maxRows:10},placeholder:"输入内容"},null,8,["modelValue"]),m(U,{type:"success",onClick:z,disabled:!l.value},{default:C(()=>[_e("发送")]),_:1},8,["disabled"])])])])),[[O,V.value]])]),_:1},512)}}});const ht=fe(Re,[["__scopeId","data-v-80d68ec8"]]);export{ht as default};
